#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os, subprocess, sys, signal
import ConfigParser
import infrasim

def ipmi_check_pid():
    cmd  = "ps ax | grep ipmi_sim"
    pipe_list = subprocess.check_output(cmd, shell=True).split("\n")
    for pipe in pipe_list:
        if len(pipe) > 100:
            return pipe
    return None

def ipmi_start(node):
    if ipmi_check_pid() is not None:
        print "inframsim_ipmi service is already running"
        return 0

    cmd = "ipmi_sim -c /etc/infrasim/vbmc.conf -f /usr/local/etc/infrasim/{0}/{0}.emu -n &"
    cmd = cmd.format(node)
    cmd_list = cmd.split(' ')
    os.system(cmd)

    #os.system("gunicorn -w 4 infrasim:app -b :80 -D")

def ipmi_stop(node):
    status = ipmi_check_pid()
    if status is None:
        print "infrasim-ipmi service is OFF"
    else:
        os.system("pkill ipmi_sim")
    os.system("pkill gunicorn")
    os.system("infrasim-vm stop")
    print "infrasim-ipmi service stopped!"

def ipmi_status(node):
    status = ipmi_check_pid()
    if status is None:
        print "infrasim-ipmi service is OFF"
        return 0

    print "infrasim-ipmi service is ON"
    return 1


def ipmi_help():
    print "inframsim_ipmi start|stop|status"

if __name__ == '__main__':
    config = ConfigParser.ConfigParser()
    config.read('/etc/infrasim/infrasim.conf')
    node = config.get('main', 'node')
    if sys.argv[1] == "start":
        ipmi_start(node)
    elif sys.argv[1] == "stop":
        ipmi_stop(node)
    elif sys.argv[1] == "status":
        ipmi_status(node)
    elif sys.argv[1] == "restart":
        ipmi_stop(node)
        print "Restart InfraSIM service..."
        ipmi_start(node)
    else:
        ipmi_help()        
